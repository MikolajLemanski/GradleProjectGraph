<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gradle Project Graph Viewer</title>
    <link rel="stylesheet" href="style.css">
    <!-- Mermaid.js for graph rendering -->
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ 
            startOnLoad: false,
            theme: 'default',
            flowchart: { 
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            securityLevel: 'loose'
        });
        window.mermaid = mermaid;
    </script>
</head>
<body>
    <!-- Page 1: Input Page -->
    <section id="input-page" class="page active">
        <div class="container">
            <header>
                <h1>Gradle Project Graph Viewer</h1>
                <p>Analyze Gradle project dependencies from GitHub repositories</p>
            </header>

            <div class="input-section">
                <div class="form-group">
                    <label for="repoUrl">GitHub Repository URL:</label>
                    <input 
                        type="text" 
                        id="repoUrl" 
                        placeholder="https://github.com/owner/repo"
                        aria-describedby="url-help"
                    >
                    <div id="url-help" class="help-text">
                        Enter a public GitHub repository URL (optionally with /tree/branch-name)
                    </div>
                    <div id="validation-message" class="validation-message"></div>
                </div>

                <button id="analyzeBtn" class="primary-button">
                    Analyze Repository
                </button>

                <div id="input-loading" class="loading-state" style="display: none;">
                    <div class="spinner"></div>
                    <p id="loading-message">Analyzing repository...</p>
                    <p id="loading-detail" class="loading-detail"></p>
                </div>

                <div id="input-error" class="error-state" style="display: none;"></div>

                <!-- Health Check Section -->
                <div class="health-check-section">
                    <hr class="section-divider">
                    <h3>System Health Check</h3>
                    <p class="help-text">Run tests to verify all components are working correctly</p>
                    <button id="runTestsBtn" class="secondary-button">
                        üîç Run Tests
                    </button>
                    <div id="test-results" class="test-results" style="display: none;"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- Page 2: Graph Page -->
    <section id="graph-page" class="page">
        <div class="container">
            <header class="graph-header">
                <div class="header-content">
                    <h1>Project Dependency Graph</h1>
                    <button id="backBtn" class="secondary-button">‚Üê Back to Input</button>
                </div>
                <div id="repo-info" class="repo-info"></div>
            </header>

            <div id="graph-loading" class="loading-state" style="display: none;">
                <div class="spinner"></div>
                <p>Rendering graph...</p>
            </div>

            <div id="graph-error" class="error-state" style="display: none;"></div>

            <div id="graph-results" class="graph-results" style="display: none;">
                <div class="graph-legend">
                    <h3>Legend</h3>
                    <div class="legend-item">
                        <span class="legend-icon project-node"></span>
                        <span>Gradle Project</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-icon dependency-edge"></span>
                        <span>Project Dependency</span>
                    </div>
                </div>

                <div id="graph-container" class="graph-container">
                    <div id="mermaid-graph"></div>
                </div>

                <div id="graph-warnings" class="warnings-section" style="display: none;">
                    <h3>‚ö†Ô∏è Warnings</h3>
                    <ul id="warnings-list"></ul>
                </div>

                <div id="graph-metadata" class="metadata-section"></div>
            </div>
        </div>
    </section>

    <!-- Module Scripts -->
    <script type="module" src="js/input-page.js"></script>
    <script type="module" src="js/graph-page.js"></script>
    <script type="module" src="js/github-client.js"></script>
    <script type="module" src="js/gradle-parser.js"></script>

    <!-- Bootstrap Application -->
    <script type="module">
        import { initInputPage } from './js/input-page.js';
        import { initGraphPage } from './js/graph-page.js';
        import { runAllTests, displayTestResults } from './js/test-orchestrator.js';

        // Initialize pages on load
        document.addEventListener('DOMContentLoaded', () => {
            initInputPage();
            initGraphPage();

            // Wire up test runner button
            const runTestsBtn = document.getElementById('runTestsBtn');
            if (runTestsBtn) {
                runTestsBtn.addEventListener('click', async () => {
                    runTestsBtn.disabled = true;
                    runTestsBtn.textContent = '‚è≥ Running tests...';
                    
                    try {
                        const results = await runAllTests();
                        displayTestResults(results);
                    } catch (error) {
                        console.error('Test execution failed:', error);
                        const resultsDiv = document.getElementById('test-results');
                        if (resultsDiv) {
                            resultsDiv.innerHTML = `<div class="test-summary failure">
                                <h3>‚úó Test Execution Failed</h3>
                                <p>${error.message || 'Unknown error'}</p>
                            </div>`;
                            resultsDiv.style.display = 'block';
                        }
                    } finally {
                        runTestsBtn.disabled = false;
                        runTestsBtn.textContent = 'üîç Run Tests';
                    }
                });
            }
        });
    </script>
</body>
</html>
