<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gradle Project Dependency Graph</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Gradle Project Dependency Graph</h1>
            <p>Analyze Gradle project dependencies from GitHub repositories</p>
        </header>

        <div class="input-section">
            <div class="form-group">
                <label for="repoUrl">GitHub Repository URL:</label>
                <input type="text" id="repoUrl" placeholder="https://github.com/owner/repo">
            </div>
            <div class="form-group">
                <label for="branch">Branch (optional):</label>
                <input type="text" id="branch" placeholder="main">
            </div>
            <button id="analyzeBtn" onclick="analyzeDependencies()">Analyze Dependencies</button>
        </div>

        <div id="loading" class="loading" style="display: none;">
            <p>Loading dependencies...</p>
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="results" class="results" style="display: none;">
            <h2>Dependency Graph</h2>
            <div id="graph"></div>
        </div>
    </div>

    <script>
        async function analyzeDependencies() {
            const repoUrl = document.getElementById('repoUrl').value.trim();
            const branch = document.getElementById('branch').value.trim() || 'main';
            
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const results = document.getElementById('results');
            const graph = document.getElementById('graph');
            
            // Reset UI
            loading.style.display = 'none';
            error.style.display = 'none';
            results.style.display = 'none';
            graph.innerHTML = '';
            
            if (!repoUrl) {
                showError('Please enter a GitHub repository URL');
                return;
            }
            
            // Parse GitHub URL
            const match = repoUrl.match(/github\.com\/([^\/]+)\/([^\/]+)/);
            if (!match) {
                showError('Invalid GitHub URL format. Expected: https://github.com/owner/repo');
                return;
            }
            
            const owner = match[1];
            const repo = match[2].replace(/\.git$/, '');
            
            loading.style.display = 'block';
            
            try {
                // Fetch build.gradle or build.gradle.kts files
                const dependencies = await fetchGradleDependencies(owner, repo, branch);
                
                loading.style.display = 'none';
                results.style.display = 'block';
                
                displayDependencyGraph(dependencies);
            } catch (err) {
                loading.style.display = 'none';
                showError('Error: ' + err.message);
            }
        }
        
        async function fetchGradleDependencies(owner, repo, branch) {
            // Try to fetch build.gradle file
            let buildFile = null;
            let fileName = '';
            
            try {
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/build.gradle?ref=${branch}`);
                if (response.ok) {
                    buildFile = await response.json();
                    fileName = 'build.gradle';
                }
            } catch (e) {
                // Try build.gradle.kts
            }
            
            if (!buildFile) {
                try {
                    const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/build.gradle.kts?ref=${branch}`);
                    if (response.ok) {
                        buildFile = await response.json();
                        fileName = 'build.gradle.kts';
                    }
                } catch (e) {
                    throw new Error('No build.gradle or build.gradle.kts found in repository');
                }
            }
            
            if (!buildFile) {
                throw new Error('No build.gradle or build.gradle.kts found in repository');
            }
            
            // Decode content
            const content = atob(buildFile.content);
            
            // Parse dependencies
            const dependencies = parseDependencies(content);
            
            return {
                fileName,
                dependencies
            };
        }
        
        function parseDependencies(content) {
            const dependencies = {
                implementation: [],
                testImplementation: [],
                api: [],
                compileOnly: [],
                runtimeOnly: [],
                other: []
            };
            
            // Simple regex to extract dependencies
            const depPattern = /(implementation|testImplementation|api|compileOnly|runtimeOnly|compile|testCompile)\s+['"]([^'"]+)['"]/g;
            
            let match;
            while ((match = depPattern.exec(content)) !== null) {
                const type = match[1];
                const dep = match[2];
                
                if (dependencies[type]) {
                    dependencies[type].push(dep);
                } else {
                    dependencies.other.push(`${type}: ${dep}`);
                }
            }
            
            return dependencies;
        }
        
        function displayDependencyGraph(data) {
            const graph = document.getElementById('graph');
            
            let html = `<div class="file-info"><strong>File:</strong> ${data.fileName}</div>`;
            
            for (const [type, deps] of Object.entries(data.dependencies)) {
                if (deps.length > 0) {
                    html += `<div class="dependency-section">`;
                    html += `<h3>${type}</h3>`;
                    html += `<ul class="dependency-list">`;
                    
                    deps.forEach(dep => {
                        html += `<li>${escapeHtml(dep)}</li>`;
                    });
                    
                    html += `</ul></div>`;
                }
            }
            
            if (html === `<div class="file-info"><strong>File:</strong> ${data.fileName}</div>`) {
                html += `<p class="no-deps">No dependencies found in the build file.</p>`;
            }
            
            graph.innerHTML = html;
        }
        
        function showError(message) {
            const error = document.getElementById('error');
            error.textContent = message;
            error.style.display = 'block';
        }
        
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
    </script>
</body>
</html>
